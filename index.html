<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lector de Texto y PDF ‚Äî Gratis (Web Speech API + PDF.js)</title>
<style>
:root { --bg:#0f172a; --panel:#111827; --accent:#22d3ee; --text:#e5e7eb; --muted:#94a3b8; --ok:#34d399; --warn:#f59e0b; --err:#f87171; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif}
header{padding:22px 16px;text-align:center;border-bottom:1px solid #1f2937}
header h1{margin:0;font-size:20px}
main{max-width:1000px;margin:0 auto;padding:16px;display:grid;gap:16px}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:16px}
.row{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr 1fr}
label{font-size:13px;color:var(--muted)}
textarea{width:100%;min-height:200px;resize:vertical;background:#0b1220;color:var(--text);border:1px solid #293244;border-radius:8px;padding:12px;line-height:1.5}
input[type="file"],select{width:100%}
select{background:#0b1220;color:var(--text);border:1px solid #293244;border-radius:8px;padding:10px}
.controls{display:flex;flex-wrap:wrap;gap:8px}
button{appearance:none;border:1px solid #1f2937;background:#0b1220;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
button.primary{background:linear-gradient(135deg,#0ea5e9,#22d3ee);color:#001018;border:none;font-weight:600}
button:disabled{opacity:.5;cursor:not-allowed}
.kv{background:#0b1220;border:1px dashed #293244;border-radius:10px;padding:10px;font-size:13px;color:var(--muted)}
.kvs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.meter{height:8px;border-radius:999px;background:#0b1220;border:1px solid #293244;overflow:hidden}
.meter > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#22d3ee,#34d399)}
.small{font-size:12px;color:var(--muted)}
.ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
footer{padding:20px;text-align:center;color:var(--muted);font-size:12px}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;background:#0b1220;border:1px solid #293244}
</style>
</head>
<body>
<header>
<h1>üó£Ô∏è Lector de Texto y PDF ‚Äî 100% Gratis, local en tu navegador</h1>
<div class="small">Funciona con <span class="badge">Web Speech API</span> + <span class="badge">PDF.js</span>. No sube archivos a ning√∫n servidor.</div>
</header>

<main>
<!-- Entrada -->
<section class="card">
<h2 style="margin-top:0">1) Carga tu contenido</h2>
<div class="row grid-2">
<div>
<label>Subir archivo (.pdf o .txt)</label>
<input id="fileInput" type="file" accept=".pdf,.txt" />
<div class="small">Los PDFs se procesan localmente con PDF.js. Los TXT se abren directo.</div>
</div>
<div>
<label>Escribe o pega texto</label>
<textarea id="textInput" placeholder="Pega aqu√≠ el texto que quieres escuchar..."></textarea>
</div>
</div>
<div class="kvs" style="margin-top:12px">
<div class="kv"><b>Estado:</b> <span id="status">Listo</span></div>
<div class="kv"><b>Idioma sugerido:</b> <span id="langHint">es-ES</span></div>
<div class="kv"><b>Longitud (caracteres):</b> <span id="lenHint">0</span></div>
</div>
</section>

<!-- Voces y par√°metros -->
<section class="card">
<h2 style="margin-top:0">2) Voz y par√°metros</h2>
<div class="row grid-2">
<div>
<label>Voz disponible en tu navegador</label>
<select id="voiceSelect"></select>
<div class="small">Elige una voz <b>es-ES</b> o <b>es-LA</b> para espa√±ol natural.</div>
</div>
<div>
<label>Velocidad</label>
<input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" />
<div class="meter"><i id="rateBar"></i></div>
</div>
</div>
<div class="row grid-2">
<div>
<label>Tono</label>
<input id="pitch" type="range" min="0" max="2" step="0.1" value="1" />
<div class="meter"><i id="pitchBar"></i></div>
</div>
<div>
<label>Volumen</label>
<input id="volume" type="range" min="0" max="1" step="0.1" value="1" />
<div class="meter"><i id="volumeBar"></i></div>
</div>
</div>
</section>

<!-- Controles -->
<section class="card">
<h2 style="margin-top:0">3) Controles</h2>
<div class="controls">
<button id="speakBtn" class="primary">‚ñ∂Ô∏è Leer</button>
<button id="pauseBtn">‚è∏Ô∏è Pausar</button>
<button id="resumeBtn">‚ñ∂Ô∏è Reanudar</button>
<button id="stopBtn">‚èπÔ∏è Detener</button>
<button id="clearBtn">üßπ Limpiar</button>
</div>
<div class="small" style="margin-top:8px">
El texto se divide en fragmentos para evitar cortes. Puedes pausar y reanudar cuando quieras.
</div>
</section>

<!-- Progreso -->
<section class="card">
<h2 style="margin-top:0">Progreso</h2>
<div class="meter"><i id="progressBar"></i></div>
<div class="small" style="margin-top:6px">
<span id="progressText">0%</span> ‚Äî <span id="chunkInfo">0 / 0</span> fragmentos
</div>
<div class="small" id="supportInfo" style="margin-top:8px"></div>
</section>
</main>

<footer>
Hecho para Ra√∫l ‚Äî uso libre. Requiere un navegador con soporte de <b>speechSynthesis</b>. PDF.js por CDN.
</footer>

<!-- PDF.js (n√∫cleo y worker) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-KiWzZfa7qv3Zj1mE2AQfCMyJOQ7NlXQK1yXQ2p6mQ2nKq35aSgQbY0ciV9ewVR5Xk+U9VujwQcZ1B1v+0s0y5A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
// *** IMPORTANTE: configurar worker de PDF.js ***
// Debe apuntar a la MISMA versi√≥n del CDN para evitar errores de "worker".
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<script>
// ---------- Utilidades y estado ----------
const $ = s => document.querySelector(s);
const state = {
chunks: [], index: 0, voices: [], utter: null,
paused: false
};
const UI = {
status: $('#status'), lenHint: $('#lenHint'), langHint: $('#langHint'),
voiceSelect: $('#voiceSelect'),
rate: $('#rate'), pitch: $('#pitch'), volume: $('#volume'),
rateBar: $('#rateBar'), pitchBar: $('#pitchBar'), volumeBar: $('#volumeBar'),
progressBar: $('#progressBar'), progressText: $('#progressText'), chunkInfo: $('#chunkInfo'),
supportInfo: $('#supportInfo')
};

function setStatus(t, cls=''){ UI.status.textContent = t; UI.status.className = cls; }
function updateLen(){ UI.lenHint.textContent = ($('#textInput').value || '').length; }
function updateMeters(){
UI.rateBar.style.width = ((UI.rate.value-0.5)/1.5*100)+'%';
UI.pitchBar.style.width = (UI.pitch.value/2*100)+'%';
UI.volumeBar.style.width = (UI.volume.value*100)+'%';
}
updateMeters();
UI.rate.addEventListener('input', updateMeters);
UI.pitch.addEventListener('input', updateMeters);
UI.volume.addEventListener('input', updateMeters);

// ---------- Soporte Web Speech ----------
function checkSupport(){
const ok = 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
UI.supportInfo.innerHTML = ok
? '‚úÖ Web Speech API disponible.'
: '‚ùå Este navegador no soporta Web Speech API. Usa Chrome/Edge/Safari.';
}
checkSupport();

function loadVoices(){
const vs = speechSynthesis.getVoices();
state.voices = vs.sort((a,b)=>a.lang.localeCompare(b.lang));
UI.voiceSelect.innerHTML = '';
state.voices.forEach((v,i)=>{
const opt = document.createElement('option');
opt.value = i; opt.textContent = `${v.name} ‚Äî ${v.lang}${v.default?' (default)':''}`;
UI.voiceSelect.appendChild(opt);
});
const esIdx = state.voices.findIndex(v=>/^es(-|_)/i.test(v.lang));
UI.voiceSelect.value = esIdx >= 0 ? esIdx : 0;
UI.langHint.textContent = esIdx>=0 ? state.voices[esIdx].lang : (state.voices[0]?.lang || '‚Äî');
}
loadVoices();
if (typeof speechSynthesis !== 'undefined') {
speechSynthesis.onvoiceschanged = loadVoices;
}

// ---------- Carga de archivos ----------
$('#fileInput').addEventListener('change', async (e)=>{
const file = e.target.files?.[0];
if(!file) return;
const ext = (file.name.split('.').pop() || '').toLowerCase();
setStatus('Procesando archivo‚Ä¶');
try{
if(ext === 'txt'){
const text = await file.text();
$('#textInput').value = text;
setStatus('TXT cargado ‚úÖ','ok');
updateLen();
} else if(ext === 'pdf'){
const buf = await file.arrayBuffer();
const text = await extractTextFromPDF(buf);
$('#textInput').value = text.trim();
setStatus('PDF extra√≠do ‚úÖ','ok');
updateLen();
} else {
setStatus('Formato no soportado. Usa PDF o TXT.','warn');
}
}catch(err){
console.error(err);
setStatus('Error al leer el archivo. Revisa el PDF.','err');
}
});

async function extractTextFromPDF(arrayBuffer){
// Manejo de errores/contrase√±as/corrupci√≥n
const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
const pdf = await loadingTask.promise;
let out = '';
for(let p=1; p<=pdf.numPages; p++){
const page = await pdf.getPage(p);
const content = await page.getTextContent();
const strings = content.items.map(it=>{
if (typeof it.str === 'string') return it.str;
if (it?.chars) return it.chars.map(c=>c?.unicode||'').join('');
return '';
});
out += strings.join(' ') + '\n\n';
}
if(!out.trim()){
throw new Error('No se pudo extraer texto (PDF escaneado/imagen).');
}
return out;
}

// ---------- Divisi√≥n en fragmentos ----------
function chunkText(text, maxLen=1800){
const paras = text.split(/\n{2,}/);
const chunks = [];
let current='';
const push=()=>{ if(current.trim()) {chunks.push(current.trim()); current='';} };

paras.forEach(p=>{
if((current+'\n\n'+p).length<=maxLen){
current = current ? current+'\n\n'+p : p;
}else{
const sentences = p.split(/(?<=[\.\?\!‚Ä¶])\s+/);
sentences.forEach(s=>{
if((current+' '+s).length<=maxLen){
current = current ? current+' '+s : s;
}else{
push();
if(s.length<=maxLen){ current=s; }
else{
for(let i=0;i<s.length;i+=maxLen) chunks.push(s.slice(i,i+maxLen));
current='';
}
}
});
}
});
push();
return chunks;
}

// ---------- Lectura ----------
function updateProgress(){
const total = state.chunks.length || 1;
const pct = Math.round((state.index/total)*100);
UI.progressBar.style.width = pct+'%';
UI.progressText.textContent = pct+'%';
UI.chunkInfo.textContent = `${Math.min(state.index,total)} / ${total}`;
}

function speakNext(){
if(state.index >= state.chunks.length){
setStatus('Lectura finalizada ‚úÖ','ok');
updateProgress();
return;
}
const utter = new SpeechSynthesisUtterance(state.chunks[state.index]);
state.utter = utter;
const v = state.voices[+UI.voiceSelect.value] || state.voices[0];
if(v) utter.voice = v;
utter.rate = +UI.rate.value;
utter.pitch = +UI.pitch.value;
utter.volume = +UI.volume.value;

utter.onstart = ()=>{
setStatus(`Leyendo fragmento ${state.index+1} de ${state.chunks.length}‚Ä¶`);
updateProgress();
};
utter.onend = ()=>{
state.index++;
updateProgress();
speakNext();
};
utter.onerror = (e)=>{
console.error(e);
setStatus('Error durante la lectura.','err');
};
speechSynthesis.speak(utter);
}

$('#speakBtn').addEventListener('click', ()=>{
const text = ($('#textInput').value||'').trim();
if(!text){ setStatus('No hay texto para leer.','warn'); return; }
if(!('speechSynthesis' in window)){ setStatus('Sin soporte Web Speech.','err'); return; }

// Reiniciar sesi√≥n anterior
speechSynthesis.cancel();
state.chunks = chunkText(text, 1800);
state.index = 0;
updateProgress();
setStatus('Iniciando lectura‚Ä¶');
speakNext();
});

$('#pauseBtn').addEventListener('click', ()=>{
if (speechSynthesis.speaking && !speechSynthesis.paused){
speechSynthesis.pause();
setStatus('Pausado ‚è∏Ô∏è');
}
});
$('#resumeBtn').addEventListener('click', ()=>{
if (speechSynthesis.paused){
speechSynthesis.resume();
setStatus('Reanudando ‚ñ∂Ô∏è');
}
});
$('#stopBtn').addEventListener('click', ()=>{
speechSynthesis.cancel();
setStatus('Detenido ‚èπÔ∏è');
updateProgress();
});
$('#clearBtn').addEventListener('click', ()=>{
speechSynthesis.cancel();
$('#textInput').value = '';
updateLen(); state.chunks=[]; state.index=0; updateProgress();
setStatus('Listo');
});
$('#textInput').addEventListener('input', updateLen);
</script>
</body>
</html>