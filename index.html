<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lector de Texto y PDF ‚Äî Soluci√≥n lectura manual</title>
<style>
:root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--ok:#34d399;--warn:#f59e0b;--err:#f87171}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif}
header{padding:22px 16px;text-align:center;border-bottom:1px solid #1f2937}
header h1{margin:0;font-size:20px}
main{max-width:1000px;margin:0 auto;padding:16px;display:grid;gap:16px}
.card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px}
.row{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr 1fr}
label{font-size:13px;color:var(--muted)}
textarea{width:100%;min-height:200px;resize:vertical;background:#0b1220;color:var(--text);border:1px solid #293244;border-radius:8px;padding:12px;line-height:1.5}
input[type="file"],select{width:100%}
select{background:#0b1220;color:var(--text);border:1px solid #293244;border-radius:8px;padding:10px}
.controls{display:flex;flex-wrap:wrap;gap:8px}
button{appearance:none;border:1px solid #1f2937;background:#0b1220;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
button.primary{background:#0ea5e9;color:#001018;border:none;font-weight:600}
button:disabled{opacity:.5;cursor:not-allowed}
.kv{background:#0b1220;border:1px dashed #293244;border-radius:10px;padding:10px;font-size:13px;color:var(--muted)}
.kvs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.meter{height:8px;border-radius:999px;background:#0b1220;border:1px solid #293244;overflow:hidden}
.meter > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#22d3ee,#34d399)}
.small{font-size:12px;color:var(--muted)}
.ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
footer{padding:20px;text-align:center;color:var(--muted);font-size:12px}
.badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;background:#0b1220;border:1px solid #293244}
</style>
</head>
<body>
<header>
<h1>üó£Ô∏è Lector ‚Äî Texto manual y PDF (local, gratis)</h1>
<div class="small">Web Speech API (TTS local) + PDF.js. Nada se sube a servidores.</div>
</header>

<main>
<!-- Entrada -->
<section class="card">
<h2 style="margin-top:0">1) Escribe/pega tu texto (prioridad)</h2>
<label for="textInput">Texto</label>
<textarea id="textInput" placeholder="Pega aqu√≠ el texto y presiona ‚ñ∂Ô∏è Probar voz o ‚ñ∂Ô∏è Leer"></textarea>
<div class="kvs" style="margin-top:12px">
<div class="kv"><b>Estado:</b> <span id="status">Listo</span></div>
<div class="kv"><b>Soporte voz:</b> <span id="support">‚Äî</span></div>
<div class="kv"><b>Longitud (caracteres):</b> <span id="len">0</span></div>
</div>
</section>

<!-- PDF opcional -->
<section class="card">
<h2 style="margin-top:0">2) (Opcional) Subir PDF / TXT</h2>
<div class="row grid-2">
<div>
<label>Archivo (.pdf o .txt)</label>
<input id="fileInput" type="file" accept=".pdf,.txt" />
<div class="small">Si el PDF es escaneado (imagen), no tiene texto. Puedo a√±adir OCR si lo necesitas.</div>
</div>
<div>
<label>Texto extra√≠do</label>
<textarea id="extracted" placeholder="Aqu√≠ aparecer√° el texto del PDF/TXT‚Ä¶"></textarea>
</div>
</div>
</section>

<!-- Voces y par√°metros -->
<section class="card">
<h2 style="margin-top:0">3) Voz y par√°metros</h2>
<div class="row grid-2">
<div>
<label>Voz</label>
<select id="voiceSelect"></select>
<div class="small">Sugerido: voces <b>es-ES</b> o <b>es-*</b> para espa√±ol.</div>
</div>
<div>
<label>Velocidad</label>
<input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" />
<div class="meter"><i id="rateBar"></i></div>
</div>
</div>
<div class="row grid-2">
<div>
<label>Tono</label>
<input id="pitch" type="range" min="0" max="2" step="0.1" value="1" />
<div class="meter"><i id="pitchBar"></i></div>
</div>
<div>
<label>Volumen</label>
<input id="volume" type="range" min="0" max="1" step="0.1" value="1" />
<div class="meter"><i id="volumeBar"></i></div>
</div>
</div>
</section>

<!-- Controles -->
<section class="card">
<h2 style="margin-top:0">4) Controles</h2>
<div class="controls">
<button id="testBtn" class="primary" disabled>‚ñ∂Ô∏è Probar voz</button>
<button id="speakBtn" class="primary" disabled>‚ñ∂Ô∏è Leer texto</button>
<button id="pauseBtn" disabled>‚è∏Ô∏è Pausar</button>
<button id="resumeBtn" disabled>‚ñ∂Ô∏è Reanudar</button>
<button id="stopBtn" disabled>‚èπÔ∏è Detener</button>
<button id="clearBtn">üßπ Limpiar</button>
</div>
<div class="small" style="margin-top:8px">
Requiere clic del usuario para iniciar audio (pol√≠ticas del navegador).
</div>
</section>

<!-- Progreso -->
<section class="card">
<h2 style="margin-top:0">Progreso</h2>
<div class="meter"><i id="progressBar"></i></div>
<div class="small" style="margin-top:6px">
<span id="progressText">0%</span> ‚Äî <span id="chunkInfo">0 / 0</span> fragmentos
</div>
</section>
</main>

<footer>
Hecho para Ra√∫l ‚Äî versi√≥n foco: lectura de TEXTO MANUAL. PDF opcional.
</footer>

<!-- PDF.js (solo si quieres usar PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-KiWzZfa7qv3Zj1mE2AQfCMyJOQ7NlXQK1yXQ2p6mQ2nKq35aSgQbY0ciV9ewVR5Xk+U9VujwQcZ1B1v+0s0y5A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'</script>

<script>
// ========= Utilidades/UI =========
const $ = s => document.querySelector(s);
const UI = {
status: $('#status'), support: $('#support'), len: $('#len'),
textInput: $('#textInput'), extracted: $('#extracted'),
voiceSelect: $('#voiceSelect'),
rate: $('#rate'), pitch: $('#pitch'), volume: $('#volume'),
rateBar: $('#rateBar'), pitchBar: $('#pitchBar'), volumeBar: $('#volumeBar'),
testBtn: $('#testBtn'), speakBtn: $('#speakBtn'),
pauseBtn: $('#pauseBtn'), resumeBtn: $('#resumeBtn'), stopBtn: $('#stopBtn'), clearBtn: $('#clearBtn'),
progressBar: $('#progressBar'), progressText: $('#progressText'), chunkInfo: $('#chunkInfo'),
fileInput: $('#fileInput')
};
const state = { voices: [], chunks: [], index: 0, speaking: false, paused: false, utter: null };

const setStatus = (msg, cls='') => { UI.status.textContent = msg; UI.status.className = cls; };
const setSupport = (msg) => UI.support.textContent = msg;
const setButtons = () => {
const hasSpeech = ('speechSynthesis' in window && 'SpeechSynthesisUtterance' in window);
const hasText = getSanitizedText(UI.textInput.value).length > 0;
UI.testBtn.disabled = !hasSpeech;
UI.speakBtn.disabled = !hasSpeech || !hasText;
UI.pauseBtn.disabled = !(state.speaking && !speechSynthesis.paused);
UI.resumeBtn.disabled= !(speechSynthesis.paused);
UI.stopBtn.disabled = !state.speaking;
};
const updateLen = () => UI.len.textContent = getSanitizedText(UI.textInput.value).length;
const updateMeters = () => {
UI.rateBar.style.width = ((UI.rate.value-0.5)/1.5*100)+'%';
UI.pitchBar.style.width = (UI.pitch.value/2*100)+'%';
UI.volumeBar.style.width = (UI.volume.value*100)+'%';
};
updateMeters();
UI.rate.addEventListener('input', updateMeters);
UI.pitch.addEventListener('input', updateMeters);
UI.volume.addEventListener('input', updateMeters);

// ========= Limpieza de texto (arregla el ‚Äúno reconoce caracteres‚Äù) =========
function getSanitizedText(raw){
if (!raw) return '';
// Normaliza tildes/√±, elimina controles no imprimibles excepto \n \t \r
let t = raw.normalize('NFC').replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g,'');
// Quita espacios no separables raros
t = t.replace(/\u00A0/g,' ');
// Recorta excesos sin perder saltos importantes
t = t.replace(/[ \t]+\n/g, '\n').replace(/\n{3,}/g, '\n\n').trim();
return t;
}

function onTextChanged(){
const clean = getSanitizedText(UI.textInput.value);
if (UI.textInput.value !== clean) {
// No sobreescribo mientras escribes; s√≥lo actualizo m√©tricas
}
updateLen();
setButtons();
}
UI.textInput.addEventListener('input', onTextChanged);
onTextChanged();

// ========= Detecci√≥n de soporte de voz =========
function checkSpeechSupport(){
const ok = ('speechSynthesis' in window && 'SpeechSynthesisUtterance' in window);
setSupport(ok ? '‚úÖ Disponible' : '‚ùå No disponible (usa Chrome/Edge/Safari)');
setButtons();
}
checkSpeechSupport();

// ========= Voces =========
function loadVoices(){
const list = speechSynthesis.getVoices().sort((a,b)=>a.lang.localeCompare(b.lang));
state.voices = list;
UI.voiceSelect.innerHTML = '';
list.forEach((v,i)=>{
const o = document.createElement('option');
o.value = i; o.textContent = `${v.name} ‚Äî ${v.lang}${v.default?' (default)':''}`;
UI.voiceSelect.appendChild(o);
});
const esIdx = list.findIndex(v=>/^es(-|_)/i.test(v.lang));
UI.voiceSelect.value = esIdx >= 0 ? esIdx : 0;
}
loadVoices();
if (typeof speechSynthesis !== 'undefined') {
speechSynthesis.onvoiceschanged = loadVoices;
}

// ========= Divisi√≥n en fragmentos =========
function chunkText(text, maxLen=1500){
const paras = text.split(/\n{2,}/);
const chunks = [];
let cur = '';
const push = () => { if (cur.trim()) { chunks.push(cur.trim()); cur=''; } };

for (const p of paras){
if ((cur+'\n\n'+p).length <= maxLen) {
cur = cur ? cur+'\n\n'+p : p;
} else {
const sents = p.split(/(?<=[\.\?\!‚Ä¶:;])\s+/);
for (const s of sents){
if ((cur+' '+s).length <= maxLen) {
cur = cur ? cur+' '+s : s;
} else {
push();
if (s.length <= maxLen) cur = s;
else {
for (let i=0;i<s.length;i+=maxLen) chunks.push(s.slice(i,i+maxLen));
cur = '';
}
}
}
}
}
push();
return chunks;
}

function updateProgress(){
const total = state.chunks.length || 1;
const pct = Math.round((state.index/total)*100);
UI.progressBar.style.width = pct + '%';
UI.progressText.textContent = pct + '%';
UI.chunkInfo.textContent = `${Math.min(state.index,total)} / ${total}`;
setButtons();
}

// ========= Lectura =========
function speakNext(){
if (state.index >= state.chunks.length){
setStatus('Lectura finalizada ‚úÖ','ok');
state.speaking = false;
updateProgress();
return;
}
const utter = new SpeechSynthesisUtterance(state.chunks[state.index]);
state.utter = utter;

const v = state.voices[+UI.voiceSelect.value] || state.voices[0];
if (v) utter.voice = v;
utter.rate = +UI.rate.value;
utter.pitch = +UI.pitch.value;
utter.volume = +UI.volume.value;

utter.onstart = ()=>{
state.speaking = true;
setStatus(`Leyendo ${state.index+1}/${state.chunks.length}‚Ä¶`);
updateProgress();
};
utter.onend = ()=>{
state.index++;
updateProgress();
speakNext();
};
utter.onerror = (e)=>{
console.error(e);
setStatus('Error durante la lectura. Revisa voz/permiso del navegador.','err');
state.speaking = false;
updateProgress();
};
speechSynthesis.speak(utter);
setButtons();
}

UI.testBtn.addEventListener('click', ()=>{
if (!('speechSynthesis' in window)) { setStatus('Sin soporte de voz.','err'); return; }
speechSynthesis.cancel();
const u = new SpeechSynthesisUtterance('Hola, esta es una prueba de voz. Si me escuchas, la s√≠ntesis funciona.');
const v = state.voices[+UI.voiceSelect.value] || state.voices[0];
if (v) u.voice = v;
u.rate = +UI.rate.value; u.pitch = +UI.pitch.value; u.volume = +UI.volume.value;
u.onstart=()=>{ state.speaking=true; setStatus('Prueba de voz‚Ä¶'); setButtons(); };
u.onend=()=>{ state.speaking=false; setStatus('Listo'); setButtons(); };
speechSynthesis.speak(u);
});

UI.speakBtn.addEventListener('click', ()=>{
const t = getSanitizedText(UI.textInput.value);
if (!t) { setStatus('No hay texto limpio para leer.','warn'); return; }
speechSynthesis.cancel();
state.chunks = chunkText(t, 1500);
state.index = 0;
updateProgress();
setStatus('Iniciando lectura‚Ä¶');
speakNext();
});

UI.pauseBtn.addEventListener('click', ()=>{
if (speechSynthesis.speaking && !speechSynthesis.paused) {
speechSynthesis.pause();
state.paused = true;
setStatus('Pausado ‚è∏Ô∏è');
setButtons();
}
});
UI.resumeBtn.addEventListener('click', ()=>{
if (speechSynthesis.paused) {
speechSynthesis.resume();
state.paused = false;
setStatus('Reanudando ‚ñ∂Ô∏è');
setButtons();
}
});
UI.stopBtn.addEventListener('click', ()=>{
speechSynthesis.cancel();
state.speaking = false;
setStatus('Detenido ‚èπÔ∏è');
updateProgress();
});
UI.clearBtn.addEventListener('click', ()=>{
speechSynthesis.cancel();
UI.textInput.value = '';
UI.extracted.value = '';
state.chunks = []; state.index = 0; state.speaking = false;
updateLen(); updateProgress(); setStatus('Listo');
});

// ========= PDF opcional =========
UI.fileInput.addEventListener('change', async (e)=>{
const f = e.target.files?.[0]; if (!f) return;
const ext = (f.name.split('.').pop()||'').toLowerCase();
setStatus('Procesando archivo‚Ä¶');
try{
if (ext==='txt'){
const txt = await f.text();
UI.extracted.value = txt;
setStatus('TXT cargado ‚úÖ','ok');
} else if (ext==='pdf'){
const buf = await f.arrayBuffer();
const text = await extractTextFromPDF(buf);
UI.extracted.value = text.trim();
setStatus('PDF extra√≠do ‚úÖ','ok');
} else {
setStatus('Formato no soportado (usa .pdf o .txt).','warn');
}
}catch(err){
console.error(err);
setStatus('No se pudo extraer texto (PDF escaneado o error).','err');
}
});

async function extractTextFromPDF(arrayBuffer){
const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
let out = '';
for (let p=1; p<=pdf.numPages; p++){
const page = await pdf.getPage(p);
const content = await page.getTextContent();
const strings = content.items.map(it => (typeof it.str==='string') ? it.str : (it?.chars?.map(c=>c?.unicode||'').join('')||''));
out += strings.join(' ') + '\n\n';
}
if (!out.trim()) throw new Error('PDF sin texto (escaneado).');
return getSanitizedText(out);
}

// Inicial
updateProgress(); setButtons();
</script>
</body>
</html>


